# Custom local build logic, invoked by d-build

# by default, continue with standard build logic once we're done here.
CONTINUE=1

# ---------- extern deps ----------

SRC_CERT="../kcore-baseline/private.d/km.crt"
SRC_KEY="../kcore-baseline/private.d/km.key"

if [[ ! -r $SRC_CERT || ! -r $SRC_KEY ]]; then
  echo "cannot read $SRC_CERT and/or ${SRC_KEY}.  Please build ../kcore-baseline first to make sure these files exist before building this container."
  exit 2
fi

cat $SRC_KEY $SRC_CERT > files/home/km/server.pem
chmod 640 files/home/km/server.pem

# ----- km server source and data

source ../build-helper.sh
copy_and_check ../../services/keymaster/km.py                  files/home/km/km.py	     750
copy_and_check ../../services/keymaster/tests/km-test.data.gpg files/home/km/km-test.data.gpg 640
copy_and_check ../../services/keymaster/private.d/km.data.gpg  files/home/km/km.data.gpg      640

