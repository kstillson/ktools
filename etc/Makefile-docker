
SHELL := /bin/bash

# Note: several targets depend on docker-infrastructure being INSTALLED
# before these targets can be BUILT.

# Furthermore, docker containers other than kds-baseline depend on
# kds-baseline being INSTALLED (i.e. marked live) before they can be BUILT.


# ---------- control constants

DOCKER_EXEC ?= /usr/bin/docker
DOCKER_VOLS ?= /rw/dv
UID := $(shell id -u)

# ----- determine if we need sudo

NEED_SUDO := 1
ifeq ($(UID), 0)
  NEED_SUDO := 0
endif
ifeq ($(DOCKER_EXEC), podman)
  NEED_SUDO := 0
endif

# ----- determine docker uid namespace mapping offsets

DOCKER_MAP_UID ?= $(shell grep dmap: /etc/subuid | cut -d: -f2)
ifeq ($(DOCKER_MAP_UID),)
  DOCKER_MAP_UID := 0
endif

DOCKER_MAP_GID ?= $(shell grep dmap: /etc/subgid | cut -d: -f2)
ifeq ($(DOCKER_MAP_GID),)
  DOCKER_MAP_GID := 0
endif

ifneq ($(UID_SEARCH),)
  UID_INSIDE ?= $(shell grep $(UID_SEARCH) files/etc/passwd | cut -d: -f3)
  UID_OUTSIDE ?= $(shell echo "$(UID_INSIDE) + $(DOCKER_MAP_UID)" | bc)
endif
ifneq ($(GID_SEARCH),)
  GID_INSIDE ?= $(shell grep $(GID_SEARCH) files/etc/group | cut -d: -f3)
  GID_OUTSIDE ?= $(shell echo "$(GID_INSIDE) + $(DOCKER_MAP_GID)" | bc)
endif


# ---------- top level logic

docker-all: build-stamp

docker-clean:
	rm -f *-stamp

docker-install: install-stamp docker-all docker-test

docker-test: docker-all test-stamp

docker-uninstall:
	@echo ":uninstall target doesn't really make sense for docker containers."

docker-update: all docker-test docker-install


# ---------- second & third level logic

build-stamp:
	if [[ "$(NEED_SUDO)" == "1" ]]; then $(MAKE) build-stamp-sudo; else $(MAKE) build-stamp-run; fi

build-stamp-sudo:
	@echo "about to sudo for docker container d-build command.  Containers can only be built by root."
	exit 2
	sudo -E $(MAKE) build-stamp-run    # -E to preserve d-build environment vars

build-stamp-run: ../kcore-baseline/baseline-stamp $(wildcard Buil* Dockerfile settings.yaml files/* files/*/* files/*/*/*)
	d-build
	touch build-stamp


install-stamp:
	if [[ "$(NEED_SUDO)" == "1" ]]; then $(MAKE) install-stamp-sudo; else $(MAKE) install-stamp-run; fi

install-stamp-sudo: build-stamp
	@echo "about to sudo for docker container d-build command.  Containers can only be built by root."
	sudo -E $(MAKE) install-stamp-run

install-stamp-run: build-stamp
	d-build -s
	touch install-stamp


test-stamp:
	if [[ "$(NEED_SUDO)" == "1" ]]; then $(MAKE) test-stamp-sudo; else $(MAKE) test-stamp-run; fi

test-stamp-sudo:
	@echo "about to sudo for docker container Test command.  Testing involves starting up a container, which only root can do."
	sudo -E $(MAKE) test-stamp-run

test-stamp-run: Test $(wildcard Buil* Dockerfile settings.yaml files/* files/*/* files/*/*/*)
	./Test -r
	touch test-stamp

# ----------

../kcore-baseline/baseline-stamp:
	$(MAKE) -C ../kcore-baseline all
